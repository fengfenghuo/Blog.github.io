# DAG网络

## 什么是DAG

DAG即有向无环图，是一种数据结构，在计算机科学中往往为了避免复杂的数据结构影响开发和数学建模会将结构进行简化或者约束，所以在图论中，为了简化这种结构，分为有向图和无向图两大类，在有向图中进一步进行约束形成了DAG（有向无环图），所谓无环是指它是由集合的顶点和有向边构成，每条边连接一个顶点到另一个，这样，在一些顶点v开始，沿着有序的边，最终循环回再次到V是不可能的，其实图是树的一种泛化，真正在用的时候一般会通过深度优先或者广度优先规则把图拆成“森林”就是多颗“树”，而DAG图由于规则的定义更容易拆成一颗“树”，这也就是为什么图有很多种，而DAG应用最为广泛的原因。

## DAG与区块链

DAG（Directed Acyclic Graph，有向无环图）在第一次被提出来结合应用在区块链时，是为了解决比特币区块生成效率低下的问题。基于链式的存储结构，比特币网络平均的出块时间在十分钟左右。而变成区块DAG后，在区块打包时间不变的情况下，可以在网络中并行打包区块，在网络中容纳更多的交易同时进行。

与区块链的工作机制不同的是，区块链需要矿工来完成工作量证明（PoW）来执行每一笔交易，而DAG能摆脱区块链的限制来完成这样的操作。相反的是，在DAG中一笔交易接着另外一笔，这意味着一笔交易能够对下一笔交易提供证明，由此一直排序下去。这些交易之间的连接就是DAG，就像区块通过哈希值来向整条区块链提供它们的名字一样。

**无区块概念与相邻交易验证机制**
通过使用这样一个系统，交易时间的将会变得微不足道，比特币也能得到良好的运作环境。在区块链的运营机制中，每笔交易要花费十分钟的时间。而通过DAG，由于每笔交易都与下一笔交易相连，且矿工被排除在外，交易时长会随着越来越多用户加入系统而缩短。

在DAG系统中，剔除矿工的设置能够避免像区块链系统中某一个矿池集合全网50%算力的威胁，与双重攻击的隐忧。那么，DAG是如何规避这样的威胁的呢？没有了区块链中的工作量证明共识机制，DAG的交易指令能够通过这么多起交易向外扩散，正因为每一笔交易都已经极快地扩散通知至全网，大部分双重支付的攻击尝试将会被系统捕捉到并立即拒绝执行。

以防在DAG网络中的并行支路上同时进行双重支付攻击，Byteball系统启用了由可信目击者（trusted witness）来运作的“主链”（main chain）。用户将能够从被验证过的和信赖的“目击者”中进行挑选，而这一条主链的记录会被认证为唯一有效的。

和以太坊相比较，DAG网络虽然不具备智能合约强制执行的特性，但它能为用户提供一个相对简单、清晰易辨的架构，以太坊的系统则要更为复杂许多。这不仅使得用户能更容易去理解他们的虚拟货币什么时候和怎么样进行支付，而非依靠着一个满是程序员和合约的世界。从这个角度来看，可以把DAG网络看出是一个智能合约缺席执行者和旁观者的版本。

## DAG解决的问题

每个新加入的单元，不仅仅只加入长链里的一个区块，而是加入到之前的所有区块。假设当你发布新交易时，前面有两个有效区块，那么你的区块会主动同时链接到前面两个之中，DAG 中的每个新单元，验证并确认其父辈单元，父辈单元的父辈单元，慢慢可达创世单元，并将其父辈单元的哈希包含到自己的单元里面。随着时间递增，所有交易的区块链相互连接，形成图状结构，如若要更改数据，那就不仅仅是几个区块的问题了，而是整个区块图的数据更改。

DAG 这个模式相比来说，要进行的复杂度更高，更难以被更改，所以这里解决了比特币与以太坊最大的一个问题隐患，就是没有一个确定的不可更改的最终状态。理论上，如果有足够的算力，足够的出块速度，产生一条更长的隐藏链，就可以把之前的区块推翻。

## 项目举例

### IOTA数据结构

Tangle(缠结)是基于定向非循环图的(DAG)，而不是一种连续的链式架构，定期添加区块。通过DAG，IOTA能够实现较高的交易吞吐量(通过平行验证)，并且不收取交易手续费。随着Tangle的不断发展，越来越多的参与者都将发起交易，整个系统也会变得越来越安全和快速，确认时间会缩短，交易也完成的越来越快。说实话，本来我看到pow的共识机制已经感叹其精妙，但看完DAG的tangle，我真觉得区块链的世界是永无止境的想象和创新。

### IOTA 共识机制

区块链共识是通过一个非常严格的机制完成的，区块链中添加下一个区块需要多方进行竞争，并获取区块奖励或交易手续费。正因如此，共识和交易生成是分离开的，并且由网络的一小部分人来完成，通常会设置较高门槛(不是每个人都会使用矿机，而且矿池日益集中的算力让人对去中心化心生疙瘩)，这样会导致进一步的中心化。

在IOTA系统中，网络中的每位参与者都能进行交易并且积极参与共识。更具体点说，你直接定位了两笔交易(主交易和分支交易)，且间接在子tangle中定位其它交易。通过这种方式，验证就能同步进行，网络能够保持完全去中心化，不需要矿工传递信任，也不需要支付交易手续费。

### 存在问题

1. 在对历史交易验证时采用随机方式，而没有任何先后规则，那么有可能产生某些交易在极端情况下没有任何其他节点对其验证，从而永远不会被确认；
2. 为了追踪每一笔交易与之前交易的关系，整个DAG图谱需要被随时检索和访问。在一个较大规模的系统中其交易图谱溯源会非常复杂，同时几乎不可能被全部保存在内存中以进行实时更新。而如果将这些数据保存在磁盘上，那么实时刷新每个Tangle的权重会造成大量随机I/O（也许可以通过大量部署SSD解决），导致极大的性能问题；
3. 由于采用谣言传播的方式将每一笔交易广播到网络中的其他节点，随着网络中节点数的增加（IOTA结构中可能会有百亿级别的设备节点，而非链式结构中几万个全账本节点），整个网络中的通讯量会程指数级上升。因此，IOTA宣称其异步机制能够大幅度提升网络流量，但是忽略了该体系需要在网络中传播的数据量远超链式结构，因此在一个具有大量节点的网络中是否还能够达到优秀的传输速度需要仔细评估；
4. IOTA宣称每个设备节点即作为验证节点又作为交易的发起节点，会对接入IOTA的设备硬件处理能力要求较高。一般来说，类似智能电表、高速公路线圈等设备使用LoRa等LPWAN协议进行通讯，设备本身基本不具备任何计算能力。因此，IOTA才尝试通过软硬件一体化的方式（号称3进制的设备）将这些复杂逻辑写入芯片，并与其它设备进行集成。